{% extends "base.html" %} {% block content %}
<section class="post_view-container">
  <div class="post_view-content">
    {% for post in posts %}
    <a href="/blog/{{ post.id }}" class="link">
      <article class="post_container">
        <div class="post_header">
          <h2>{{ post.title }}</h2>
          <p>Publi√© le {{ post.created_at|date:"j F Y" }}</p>
        </div>
        <p>{{ post.content|safe|truncatewords:50 }}</p>
        <p>{{ post.user }}</p>
        
      <!-- Section des likes -->
      <div class="post_actions">
        {% if user.is_authenticated %}
          <button class="like-btn" data-post-id="{{ post.id }}" data-liked="false">
            <span class="like-icon">ü§ç</span>
            <span class="like-count">{{ post.get_likes_count }}</span>
          </button>
        {% else %}
          <span class="like-display">
            <span class="like-icon">ü§ç</span>
            <span class="like-count">{{ post.get_likes_count }}</span>
          </span>
        {% endif %}
      </div>
    </article>
    </a>
    {% endfor %}
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const likeButtons = document.querySelectorAll('.like-btn');
    
    // Charger l'√©tat initial des likes pour chaque bouton
    likeButtons.forEach(button => {
        const postId = button.dataset.postId;
        
        // R√©cup√©rer l'√©tat initial
        fetch(`/blog/like-status/${postId}/`, {
            method: 'GET',
        })
            .then(response => response.json())
            .then(data => {
                const icon = button.querySelector('.like-icon');
                const count = button.querySelector('.like-count');
                
                if (data.liked) {
                    icon.textContent = 'üíô';
                    button.dataset.liked = 'true';
                } else {
                    icon.textContent = 'ü§ç';
                    button.dataset.liked = 'false';
                }
                count.textContent = data.likes_count;
            })
            .catch(error => {
                console.error('Erreur lors du chargement de l\'√©tat des likes:', error);
            });
        
        // G√©rer les clics
        button.addEventListener('click', function() {
            const postId = this.dataset.postId;
            
            fetch(`/blog/like/${postId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                // Mettre √† jour l'ic√¥ne
                const icon = this.querySelector('.like-icon');
                const count = this.querySelector('.like-count');
                
                if (data.liked) {
                    icon.textContent = 'üíô';
                    this.dataset.liked = 'true';
                } else {
                    icon.textContent = 'ü§ç';
                    this.dataset.liked = 'false';
                }
                
                // Mettre √† jour le compteur
                count.textContent = data.likes_count;
            })
            .catch(error => {
                console.error('Erreur:', error);
            });
        });
    });
});

// Fonction pour r√©cup√©rer le token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
