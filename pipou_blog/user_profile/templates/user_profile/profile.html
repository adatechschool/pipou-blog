{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="profile-container">
     <div class="profile-picture-container">
        {% if user_profile.profile_picture %}
            <img src="{{ user_profile.profile_picture.url }}" alt="Photo de profil" class="profile-picture">
        {% else %}
            <img src="{% static 'images/LOGO5.png' %}" alt="Photo de profil" class="profile-picture">
        {% endif %}
    </div>

    <h1>{{ user_profile.username|default:user_profile.email }}</h1>

    <p><strong>Email :</strong> {{ user_profile.email }}</p>
    <p><strong>Nom :</strong> {{ user_profile.first_name|default:"Non renseign√©" }}</p>
    <p><strong>Pr√©nom :</strong> {{ user_profile.last_name|default:"Non renseign√©" }}</p>
    <p><strong>Biographie :</strong> {{ user_profile.biography|default:"Aucune biographie." }}</p>
    <p><small>Membre depuis le {{ user_profile.date_joined|date:"d F Y" }}</small></p>

    {% if user == user_profile %}
    <div class="profile-actions">
                <a href="{% url 'edit_profile' %}" class="btn btn-primary">Modifier le profil</a>
    </div>
    {% endif %}
</div>
<section class="post_view-container">
  <div class="post_view-content">
    {% if user_posts %} {% for post in user_posts %}
    <article class="post_container">
      <div class="post_header">
        <h2>{{ post.title }}</h2>
        <p>Publier le {{ post.created_at|date:"j F Y" }}</p>
      </div>
      <p>{{ post.content|safe|truncatewords:50 }}</p>
      <div class="post_content">
        <p>{{ post.user }}</p>
        <div class="post_icons">
          <div class="post_icons">
            <a href="/blog/edit/{{ post.id }}">
              <img class="update" src="{% static 'images/icons/update.svg' %}" alt="update icon" width="24">
            </a>
            <form method="POST" action="/blog/delete/{{ post.id }}" style="display:inline;" class="delete-form">
              {% csrf_token %}
              <button class="submit-btn-trash" type="submit" title="Supprimer">
                <img class="trash" src="{% static 'images/icons/trash.svg' %}" alt="trash icon" width="24">
              </button>
            </form>
          </div>
        </div>
      
      </div>
         <!-- Section des likes -->
      <div class="post_actions">
        {% if user.is_authenticated %}
          <button class="like-btn" data-post-id="{{ post.id }}" data-liked="false">
            <span class="like-icon">ü§ç</span>
            <span class="like-count">{{ post.get_likes_count }}</span>
          </button>
        {% else %}
          <span class="like-display">
            <span class="like-icon">ü§ç</span>
            <span class="like-count">{{ post.get_likes_count }}</span>
          </span>
        {% endif %}
      </div>
    </article>
    {% endfor %} {% else %}
    <p>Aucun post pour cet utilisateur.</p>
    {% endif %}
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const likeButtons = document.querySelectorAll('.like-btn');
    
    // Charger l'√©tat initial des likes pour chaque bouton
    likeButtons.forEach(button => {
        const postId = button.dataset.postId;
        
        // R√©cup√©rer l'√©tat initial
        fetch(`/blog/like-status/${postId}/`, {
            method: 'GET',
        })
            .then(response => response.json())
            .then(data => {
                const icon = button.querySelector('.like-icon');
                const count = button.querySelector('.like-count');
                
                if (data.liked) {
                    icon.textContent = 'üíô';
                    button.dataset.liked = 'true';
                } else {
                    icon.textContent = 'ü§ç';
                    button.dataset.liked = 'false';
                }
                count.textContent = data.likes_count;
            })
            .catch(error => {
                console.error('Erreur lors du chargement de l\'√©tat des likes:', error);
            });
        
        // G√©rer les clics
        button.addEventListener('click', function() {
            const postId = this.dataset.postId;
            
            fetch(`/blog/like/${postId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                // Mettre √† jour l'ic√¥ne
                const icon = this.querySelector('.like-icon');
                const count = this.querySelector('.like-count');
                
                if (data.liked) {
                    icon.textContent = 'üíô';
                    this.dataset.liked = 'true';
                } else {
                    icon.textContent = 'ü§ç';
                    this.dataset.liked = 'false';
                }
                
                // Mettre √† jour le compteur
                count.textContent = data.likes_count;
            })
            .catch(error => {
                console.error('Erreur:', error);
            });
        });
    });
});

// Fonction pour r√©cup√©rer le token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}

